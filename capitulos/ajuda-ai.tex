% ----------------------------------------------------------
% Ajuda.Ai
% ----------------------------------------------------------
\chapter{Ajuda.Ai} \label{cha:ajudaai}

O projeto Ajuda.Ai é um software de código fonte aberto que visa ajudar instituições a arrecadar doações através da internet e aos usuários a doarem para instituições de forma simples, semelhante a adquirir um produto numa loja online, estar bem integrado junto a plataformas de redes sociais e unir doadores e instituições. O projeto apresentado foi construído com uma interface para ser acessada pelo navegador através de uma aplicação web de página única (\emph{Single Page Application}), apesar de dar suporte a outros tipos de interface, e no lado do servidor uma aplicação Java em um servidor de aplicação RedHat WildFly 10.





\section{Características da Implementação} \label{sec:ajudaai:impl}

O sistema utiliza a plataforma Java em sua versão 8. Para facilitar a configuração da aplicação e gestão de dependências se utilizou a ferramenta Apache Maven\footnote{https://maven.apache.org}, que provê um fácil acesso a uma grande quantidade de ferramentas e bibliotecas. Além da resolução de dependências, o Apache Maven facilita o processo de construção e montagem da aplicação, automatiza a produção da documentação da aplicação apartir do JavaDoc\footnote{Padrão de documentação Java que utiliza comentários com formatação para documentar a aplicação} e é considerado uma ferramenta padrão da indústria.

Como arcabouço para desenvolvimento de aplicação web se utilizou o Caelum VRaptor. O VRaptor é um arcabouço brasileiro MVC de código fonte aberto que traz alta produtividade para um desenvolvimento Java Web rápido e fácil com CDI\footnote{Retirado de http://www.vraptor.org/pt/ em 17/02/2017}. Dentre as funcionalidades mais interessantes do VRaptor estão a integração completa e simples com o arcabouço JBoss Weld, implementação de referência da especificação JSR 365\footnote{Especificação Java para um sistema de Injeção de Dependências usando o Padrão de Projeto Inversão de Controle} e arcabouço utilizado pelo RedHat Wildfly 10, e o uso do estilo convenção sob configuração onde se promove que, seguindo convenções bem definidas, não é necessário arquivos de configuração.

Para persistência de dados foi utilizado o arcabouço JBoss Hibernate ORM. Como um arcabouço de mapeamento objeto-relacional o Hibernate ORM faz a persistência de dados em banco de dados relacionais via JDBC\footnote{Retirado de http://hibernate.org/orm/ em 17/02/2017}. Como solução para banco de dados foi utilizado o SGBD MariaDB, banco de dados de código aberto que surgiu a partir do MySQL quando o mesmo foi comprado pela Oracle em 2003. Ele é mantido pelos desenvolvedores originais do MySQL e eles garantem que sempre será um projeto de código aberto. usuários notáveis incluem Wikipedia, WordPress.com e Google\footnote{Retirado de https://mariadb.org/about/ em 17/02/2017}.

Por fim, senhas são criptografadas no banco de dados se utilizando do algoritmo BCrypt. O BCrypt é uma função de \emph{hashing} de senhas projetada em 1999 por Niels Provos e David Mazières baseada na cifra \emph{Blowfish}. Além de incorporar um \emph{salt} para proteger as senhas contra ataques de tabelas arco-íris\footnote{\emph{Rainbow Table Attack}: Ataque que consiste em gerar um gigantesco banco de dados de \emph{hashes} pré-processados onde é possível se buscar pelo texto simples de um determinado \emph{hash} de um determinado algoritmo} o BCrypt é uma função adaptável: com o tempo, a contagem de iterações pode ser aumentada para torná-la mais lenta, para que ela continue resistente a ataques de força-bruta \cite{wiki:Bcrypt}.





\section{Apresentação da Aplicação} \label{sec:ajudaai:apresentacao}
%\textbf{\textit{Aqui será apresentado screenshots e essas coisas. Ainda não sei exatamente de que maneira ou que texto escrever para apresentar as figuras. Talvez um run-down do processo de doação?}}

Nesta sessão será apresentada de forma ilustrada a solução desenvolvida neste trabalho. Parte do projeto visual, cores e detalhes estéticos são de autoria de Cândido Sales Gomes. A figura \ref{fig:ss_ajudaai_01} apresenta a página inicial do projeto Ajuda.Ai. Nela temos um painel rotativo informativo com âncoras para páginas informativas sobre o projeto, uma lista mesclada entre instituições mais recentemente cadastradas no projeto e outras escolhidas aleatoriamente e uma seção com um pequeno mapa de âncoras para todas as páginas informativas do projeto.

\begin{figure}[H]
	\caption{\label{fig:ss_ajudaai_01}Captura de Tela da Página Inicial do Projeto Ajuda.Ai}
    \centering
    \includegraphics[scale=0.375]{imagens/screenshot-ajudaai-01.png}
    \legend{Fonte: Elaborado pelo Autor}
\end{figure}

A estrutura do sítio segue em grande parte a mesma estrutura visual na figura \ref{fig:ss_ajudaai_01}: uma barra de navegação de posicionamento fixo no topo da tela, um painel com uma grande figura e uma frase de cabeçalho, o conteúdo da página atual e o rodapé.

Na figura \ref{fig:ss_ajudaai_02} é apresentada uma página interna, especificamente a página ``Sobre'', que fala em linhas gerais sobre o projeto. Este mesmo modelo é utilizado para todas as páginas internas, representadas pela entidade \codigo{Page}, apresentada na seção \ref{sec:ajudaai:organizacao}.

\begin{figure}[H]
	\caption{\label{fig:ss_ajudaai_02}Captura de Tela da Página Sobre do Projeto Ajuda.Ai}
    \centering
    \includegraphics[scale=0.4]{imagens/screenshot-ajudaai-02.png}
    \legend{Fonte: Elaborado pelo Autor}
\end{figure}

A seguir, na figura \ref{fig:ss_ajudaai_03} é apresentada uma página de Instituição. Elementos visuais como a imagem do painel e logomarca da instituição são personalizáveis através de configurações da interface de administração. Além disso, é apresentado ao navegante uma contagem atualizada de quantas doações a instituição recebeu e o valor total das doações. O projeto visual do Ajuda.Ai se utiliza uma técnica de comunicação chamada \emph{Call-To-Action} onde elementos que invocam ações, como botões, têm seu texto escrito de forma imperativa a fim de incentivar quem o lê a tomar a ação. É possível observar um uso da técnica no botão ``Quero Ajudar'' na figura \ref{fig:ss_ajudaai_03}, o qual leva o usuário a página onde é possível se fazer uma doação.

\begin{figure}[H]
	\caption{\label{fig:ss_ajudaai_03}Captura de Tela da Página da Instituição AMA do Projeto Ajuda.Ai}
    \centering
    \includegraphics[scale=0.4]{imagens/screenshot-ajudaai-03.png}
    \legend{Fonte: Elaborado pelo Autor}
\end{figure}

Ao clicar no botão ``Quero Ajudar'' ou na aba ``Fazer uma Doação'' o usuário é levado a página de doação, cujo conteúdo é exibido na figura \ref{fig:ss_ajudaai_04}. Como forma de incentivo a doações maiores, uma singela forma de \emph{gamefication}\footnote{Técnica onde se introduz elementos de jogos a fim de otimizar a execução de certas ações} foi utilizada na forma de uma barra de progresso com marcadores que é preenchida de acordo com o valor da doação, inicialmente em R\$ 20,00. É dada a opção de anonimato através da proibição da exibição do nome do doador. O nome e e-mail serão gravados para a emissão da ordem de pagamento junto ao \emph{Gateway}, mas se a publicação for proibida o nome não será exibido em lugar algum, nem mesmo para a instituição que recebeu a doação.

Por segurança, a página também inclui um teste CAPTCHA do serviço Google reCAPTCHA. O serviço reCAPTCHA é um sistema de caixa de diálogo para usuário baseado na interface do CAPTCHA, que pede para usuários digitarem palavras distorcidas exibidas na tela, para ajudar a digitalizar o texto de livros, enquanto protege \emph{sites} de robôs tentando acessar áreas restritas. O serviço fornece, para os \emph{sites} inscritos, imagens de palavras que o software de reconhecimento ótico de caracteres (OCR) não foi capaz de identificar as quais são apresentadas para humanos decifrarem como palavras CAPTCHAs, como parte do seu procedimento normal de validação. Depois eles retornam os resultados para o serviço reCAPTCHA, que envia esses resultados para a digitalização de seus projetos \cite{wiki:ReCAPTCHA}.

\begin{figure}[H]
	\caption{\label{fig:ss_ajudaai_04}Captura de Tela do Formulário de Doação}
    \centering
    \includegraphics[scale=0.6]{imagens/screenshot-ajudaai-04.png}
    \legend{Fonte: Elaborado pelo Autor}
\end{figure}

Esta interface com o usuário através de uma folha de estilos CSS adequada pode se adaptar ao dispositivo onde a página está sendo exibida. Nas figuras \ref{fig:ss_ajudaai_05} e \ref{fig:ss_ajudaai_06} temos duas capturas de tela de como a interface se adapta quando exibida em um telefone celular.



\textbf{\textit{--- Mostrar mais coisas? Falta colocar o login e o admin de volta ao ar ---}}








\section{Organização do Projeto} \label{sec:ajudaai:organizacao}
O projeto está organizado numa estrutura de Projeto Pai e Projetos Filhos do Apache Maven. Essa organização facilita na manutenção e montagem da aplicação no momento da distribuição ou \emph{deployment} da mesma. Os projetos filhos são:

\begin{lista}
  \item \textbf{util}: Classes utilitárias usado pelos outros projetos. As duas classes mais utilizadas são \codigo{StringUtils}, com utilitários para comparação e processamento de Strings, e \codigo{SendMail}, que utiliza a API \codigo{javax.mail} para enviar e-mails com tipo MIME HTML;
  \item \textbf{model}: Contém o modelo de dados do Ajuda.Ai, apresentado na figura \ref{fig:uml_model};
  \item \textbf{persistence-sql}: Provê classes que implementam a persistência do projeto model em um banco de dados SQL através do JBoss Hibernate;
  \item \textbf{backend}: Servidor de Back-end do Ajuda.Ai. Aplica as regras de negócio, organiza pagamentos e atende requisições dos usuários;
  \item \textbf{frontend}: Aplicação de Página Única do Front-end do Ajuda.Ai. Uma interface web simples e agradável para utilização do sistema;
  \item \textbf{payment-api}: Projeto pai para as implementações de pagamentos dos diferentes \emph{Gateways} de pagamento;
  \item \textbf{payment-impl-moip}: Implementação de payment-api para o \emph{gateway} MoIP;
  \item \textbf{payment-impl-pagseguro}: Implementação de payment-api para o \emph{gateway} PagSeguro;
  \item \textbf{tests}: Testes do sistema.
\end{lista}

O modelo de dados da aplicação é o seguinte:

\begin{figure}[H]
	\caption{\label{fig:uml_model}Diagrama UML de Classes Resumido do Modelo do Ajuda.Ai}
    \centering
	\begin{tikzpicture}
    	\begin{umlpackage}[x=-3.5, y=0]{ajuda{.}ai{.}model{.}user}
        	\umlclass[x=0, y=0]{User}{
            	- id : Long \\
				- username : String \\
				- password : String \\
				- email : String \\
				- firstname : String \\
				- lastname : String
            }{}
		\end{umlpackage}
        
        \begin{umlpackage}[x=-1.5, y=-15]{ajuda{.}ai{.}model{.}billing}
        	\umlclass[x=0, y=0]{Payment}{
            	- id : Long \\
                - uuid : String \\
				- institution : Institution \\
                - creation : CreationInfo \\
				- description : String \\
				- paymentService : String \\
				- paymentServiceId : String \\
				- value : int \\
				- realValue : int \\
				- paid : boolean \\
				- readyForAccounting : boolean \\
				- cancelled : boolean \\
				- payeeName : String \\
				- payeeEmail : String \\
				- events : List<PaymentEvent>
            }{}
            \umlclass[x=7.5, y=0]{PaymentEvent}{
            	- id : Long \\
                - payment : Payment \\
				- timestamp : Date \\
				- transactionServiceId : String \\
				- status : int \\
				- currency : String \\
				- value : int \\
				- paymentType : String \\
				- paymentTypeInfo : String
            }{}
		\end{umlpackage}
        
        \begin{umlpackage}[x=2.7, y=0]{ajuda{.}ai{.}model{.}extra}
        	\umlclass[x=4.8, y=0]{Page}{
            	- id : Long \\
				- slug : String \\
				- creation : CreationInfo \\
				- headerImage : String \\
				- title : String \\
				- subtitle : String \\
				- content : String \\
				- published : boolean
            }{}
            \umlclass[x=0, y=0]{CreationInfo}{
            	- time : Date \\
				- lastUpdate : Date \\
				- creator : User \\
				- lastUpdateBy : User
            }{}
		\end{umlpackage}
        
        \begin{umlpackage}[x=-2.1, y=-6.5]{ajuda{.}ai{.}model{.}institution}
        	\umlclass[x=0, y=0]{Institution}{
            	- id : Long \\
				- slug : String \\
				- creation : CreationInfo \\
				- name : String \\
				- description : String \\
				- paymentService : String \\
				- attributes : Map<String, String>
            }{}
            \umlclass[x=6.5, y=0]{InstitutionPost}{
				- institution : Institution \\
				- pageviews : long
            }{}
		\end{umlpackage}
        
        
		
        
        
        \umlinherit[very thick]{InstitutionPost}{Page}
        \umlcompo[very thick]{CreationInfo}{User}
        \umlcompo[anchor1=65, very thick]{Payment}{Institution}
        \umlcompo[mult1=1, arg2=*, very thick]{Payment}{PaymentEvent}
        \umluniassoc[anchor1=58, anchor2=-120, very thick]{Payment}{CreationInfo}
      	\umluniassoc[very thick]{Institution}{CreationInfo}
        \umluniassoc[very thick]{Page}{CreationInfo}
  \end{tikzpicture}
  \legend{Fonte: Elaborado pelo Autor}
\end{figure}

Na ilustração da figura \ref{fig:uml_model} é apresentado um diagrama UML de classes do projeto \emph{model}. Estas são as principais entidades do sistema e seus relacionamentos:

\begin{lista}
%% ajuda.ai.model.user
\item \codigo{\textbf{User}}: Usuário simples. Todos os usuários podem ter Instituições e só poderão alterar informações vinculadas a ele mesmo;

%% ajuda.ai.model.extra
\item \codigo{\textbf{CreationInfo}}: Entidade embarcável\footnote{Uma Entidade Embarcável é uma classe que, no esquema objeto-relacional da plataforma Java, não tem uma tabela no SGBD própria e sim faz parte da tabela das classes que se associam a esta classe.} que guarda quando uma entidade foi criada, que usuário a criou, quando foi feita a última alteração na entidade e qual usuário fez a alteração. Caso o usuário que criou ou alterou seja nulo se considera que foi uma ação tomada pelo próprio Sistema;
\item \codigo{\textbf{Page}}: Uma página de conteúdo livre do Ajuda.Ai. Representa uma página web cujo conteúdo mude com pouca frequência;

%% ajuda.ai.model.institution
\item \codigo{\textbf{Institution}}: Representa uma Instituição criada por um Usuário;
\item \codigo{\textbf{InstitutionPost}}: Uma página de conteúdo livre vinculada a uma Instituição. Estende \codigo{Page};

%% ajuda.ai.model.billing
\item \codigo{\textbf{Payment}}: Representa uma ordem de pagamento feita pelo Sistema a um \emph{Gateway} de Pagamento em nome de um Usuário;
\item \codigo{\textbf{PaymentEvent}}: Representa uma mudança de estado de um pagamento como informado pelo \emph{Gateway} de Pagamento;
\end{lista}

\textbf{\textit{--- O que mais explicar a partir deste ponto? ---}}







\section{Arquitetura} \label{sec:ajudaai:arquitetura}

Como arquitetura do sistema se escolheu uma arquitetura REST Web onde o \emph{Back End} é totalmente separado do \emph{Front End}. Dessa forma o \emph{Back End} preocupa-se apenas em atender requisições menores e que envolvem dados e regra de negócio e o \emph{Front End} preocupa-se apenas com a exibição de informações e a interação com o usuário. Dessa forma se permite que seja feita uma separação completa entre \emph{Front End} e \emph{Back End}. Assim a interface com o usuário pode ser feita se utilizando um navegador e HTML5 ou um aplicativo para plataformas móveis como Google Android e Apple iOS.

A figura \ref{fig:arquitetura} ilustra a arquitetura do Ajuda.Ai, que utiliza uma arquitetura REST Web, arquitetura recomendada para aplicações web pela W3C\footnote{\emph{World Wide Web Consortium}, consórcio de empresas e profissionais que buscam padronizar a WWW} em \cite{booth2004webservices}, que define REST Web como ``um subconjunto da WWW (baseado em HTTP) onde agentes provêm semânticas uniformes para interfaces ao contrário de interfaces arbitrárias ou específicas de uma aplicação, e manipulam recursos apenas pela troca de representações.''

\begin{figure}[H]
  \caption{\label{fig:arquitetura}Arquitetura do Ajuda.Ai}
  \centering
  \includegraphics[scale=0.7]{imagens/ajudaAi-arquitetura.pdf}
  \legend{Fonte: Elaborado pelo Autor}
\end{figure}

Requisições são feitas ao sistema de duas origens: A interface com o usuário e os \emph{gateways} de pagamento. As requisições feitas pela interface são padronizadas como JSON a fim de facilitar a criação de aplicações modernas e diminuir o tráfego de dados. Já requisições feitas pelos \emph{gateways} são suportadas em XML, JSON, \emph{x-www-form-urlencoded} (formulário HTML padrão) e \emph{form-data} (formulário HTML com dados longos, definido pelo RFC2388).

Um dos diferenciais do Ajuda.Ai é o suporte a diferentes \emph{gateways} de pagamento. Isso dá flexibilidade a instituição para usar o \emph{gateway} mais adequado a mesma. Para implementação foi utilizado o Padrão de Projeto de Software \emph{Strategy}, como ilustrado na figura \ref{fig:uml_strategy}. Este Padrão de Projeto é definido por uma família de algoritmos encapsulados e que podem ser trocados dentro da família de objetos \cite{gamma1995design}.

\begin{figure}[H]
	\caption{\label{fig:uml_strategy}Estrutura dos Processadores de Pagamento}
    \centering
	\begin{tikzpicture}
		\umlclass[type=interface]{PaymentGateway}{}{
			+ createPayment() : Payment \\
            + processEvent() : PaymentEvent}
        \umlclass[x=-3.5, y=-4]{MoipPaymentGateway}{}{
			+ createPayment() : Payment \\
            + processEvent() : PaymentEvent}
        \umlclass[x=3.5, y=-4]{PagSeguroPaymentGateway}{}{
			+ createPayment() : Payment \\
            + processEvent() : PaymentEvent}
        \umlsimpleclass[x=-3, y=3]{InstitutionSiteController}
        \umlsimpleclass[x=3, y=3]{TransactionNotificationsController}
        \umlcompo[very thick]{InstitutionSiteController}{PaymentGateway}
        \umlcompo[very thick]{TransactionNotificationsController}{PaymentGateway}
        \umlimpl[very thick]{MoipPaymentGateway}{PaymentGateway}
        \umlimpl[very thick]{PagSeguroPaymentGateway}{PaymentGateway}
  \end{tikzpicture}
  \legend{Fonte: Elaborado pelo Autor}
\end{figure}

Cada implementação de \emph{gateway} de pagamento suportado implementa a interface PaymentGateway. Esta interface tem dois métodos:

\begin{lista}
  \item \textbf{\codigo{createPayment()}}: Cria uma ordem de pagamento junto ao \emph{gateway} de pagamento. Esse método tem liberdade de redirecionar o usuário para o sistema do \emph{gateway} (MoIP e a maioria dos gateways nacionais) ou enviar algum pedaço de informação, como JSON, como resposta ao usuário (PayPal + JavaScript para pagamento na própria página). Este método deve retornar um objeto \codigo{Payment} para ser persistido a fim de acompanhar o andamento do pagamento;

  \item \textbf{\codigo{processPayment()}}: \emph{Gateways} de pagamento enviam requisições de volta ao sistema informando sobre o status de um determinado pagamento feito na plataforma deles. Esse método é encarregado de processar essas mudanças de estado no pagamento. Este método deve retornar um objeto \codigo{PaymentEvent} que indica de forma padronizada o que aconteceu com este pagamento.
\end{lista}

Ao criar uma ordem de pagamento através de \codigo{createPayment()} a classe que a criou retorna um objeto \codigo{Payment} para ser persistido. Esse objeto, além de padronizar as informações relevantes dos pagamentos, guarda consigo a estratégia (serviço de pagamento) utilizada para criar a ordem de pagamento. Essa informação é usada futuramente quando o sistema recebe uma notificação de estado de pagamento.

Uma vantagem da utilização do padrão \emph{Strategy} é que diferentes usos de um mesmo \emph{gateway} podem ser facilmente implementados. Por exemplo, o \emph{gateway} MoIP oferece várias formas para criar ordens de pagamento. Três delas são interessantes para o que o Ajuda.Ai propõe:

\begin{lista}
  \item \textbf{Ordem de pagamento via e-mail:} O MoIP envia um e-mail para o usuário onde, na conveniência do mesmo, ele tem 30 dias para efetuar o pagamento da forma como preferir;
  \item \textbf{\emph{Check-out} Clássico:} O usuário é redirecionado para o \emph{Gateway} onde ele selecionará forma de pagamento e fará todo o processo de pagamento antes de voltar ao Ajuda.Ai --- Essa forma está disponível em todos os \emph{gateways} e é a forma preferencial de se fazer a interação de pagamento junto ao usuário;
  \item \textbf{\emph{Check-out} Transparente:} O usuário preenche tudo no próprio sistema o qual junto ao \emph{gateway} e através de \emph{webservices} faz uma ordem de pagamento e processamento de pagamento --- Esta forma está disponível em quase todos os \emph{gateways}.
\end{lista}

O Ajuda.Ai se utiliza da segunda forma demonstrada, o \emph{Check-Out} Clássico, pois é suportada por todos os \emph{gateways} e recomendada pelos mesmos por prover um ambiente seguro e que os usuários demonstram maior confiança ao partilhar dados sigilosos e pessoais como números de cartão de crédito e CPF. Esse processo de pagamento será detalhado na próxima subseção.

\textbf{\textit{--- O que mais botar aqui? ---}}





\subsection{Processo Comum de Pagamentos Online} \label{sec:ajudaai:processo_pagamento}

A ilustração da figura \ref{fig:gateway} mostra o fluxo de criação e processamento de pagamento comum a maioria dos \emph{gateways} atualmente no mercado. Todo o processo acontece entre duas entidades que são o Sistema, que é o sistema que irá gerar as ordens de pagamento e ser notificado do andamento dos pagamentos, e o próprio \emph{Gateway} de Pagamento. O processo começa com a geração de uma ordem de pagamento junto ao \emph{gateway}, a qual pode ser feita de duas maneiras:

\begin{lista}
	\item \textbf{Pagamento Normal}: Nessa modalidade o Sistema faz um HTTP POST com dados sobre o que está sendo comprado ao \emph{Gateway} e o usuário é redirecionado até uma página do próprio \emph{Gateway} de pagamento. Esse é o modo recomendado pelos \emph{Gateways}, pois os \emph{Gateways} podem servir a página de forma segura, protegida através de certificados digitais confiáveis, com uma interface de usuário adequada e, segundo os \emph{Gateways}, os clientes ficam mais propensos a concluir a compra quando o pagamento utiliza esse formato, pois os mesmos confiam na marca do \emph{Gateway} e na segurança do ambiente;
	\item \textbf{Pagamento Transparente}: Nessa modalidade todos os dados do pagamento são preenchidos em uma interface provida pelo próprio Sistema e enviados de forma segura ao \emph{Gateway} de Pagamento, o qual imediatamente cria e inicia o processamento do pagamento da uma ordem de pagamento.
\end{lista}

\begin{figure}[H]
	\caption{\label{fig:gateway}Fluxo de um Pagamento via \emph{Gateway} de Pagamento}
    \centering
    \includegraphics[scale=0.575]{imagens/processo_gateway.pdf}
    \legend{Fonte: Elaborado pelo Autor}
\end{figure}

O Ajuda.Ai faz uso da primeira maneira, o Pagamento Normal, onde o usuário é redirecionado ao \emph{Gateway}. Após a criação do pedido de pagamento e o preenchimento das informações necessárias, como dados pessoais, CPF e outros, o \emph{Gateway} cria um pagamento em seu sistema, e a partir desse ponto começa a máquina de estados do \emph{Gateway}. A máquina apresentada é uma simplificação e normalização do que ocorre na maioria dos \emph{Gateways}.

Na ilustração da figura \ref{fig:gateway} as setas de cor azul representam o fluxo como visto pelo usuário do Sistema. O usuário preenche algumas informações no próprio Sistema ou no \emph{Gateway} e, ao enviar, é feita a ordem de pagamento e o usuário é redirecionado de volta ao Sistema em uma página de ``Obrigado'', página do Sistema para onde o \emph{Gateway} irá redirecionar o usuário ao final do fluxo de criação da ordem de pagamento.

Ao criar uma ordem de pagamento, se inicia uma máquina de estados do pagamento que muda de acordo com o andamento do pagamento ou ações do usuário. Durante os estados na máquina de estados do \emph{Gateway} cada alteração de estado resulta em uma notificação ao sistema, representadas pelas setas na cor laranja. Esse comportamento é típico do padrão de projetos \emph{Event Notifier}, também conhecido como \emph{Publish-Subscribe} ou \emph{Pub-Sub}. Esse padrão de projeto ``permite que componentes reajam a ocorrência de eventos particulares em outros componentes sem que seja necessário o conhecimento de um ao outro, ao mesmo tempo que permite a participação dinâmica de componentes e a introdução de novos eventos.'' \cite{gupta2000event}

Como parte da implementação deste padrão de projeto, os \emph{gateways} de pagamento provêm alguma maneira de configurar quais URL do Sistema deverá ser chamada para receber as notificações geradas pelas trocas de estado. Na ilustração da figura \ref{fig:config_moip} está a configuração desta opção no sistema do \emph{gateway} MoIP.

\begin{figure}[H]
	\caption{\label{fig:config_moip}Configuração de Notificação do \emph{Gateway} de Pagamento MoIP}
    \centering
    \includegraphics[scale=0.85]{imagens/config-moip.png}
    \legend{Fonte: Elaborado pelo Autor}
\end{figure}

A cada alteração de estado do pagamento uma requisição específica a URL configurada será feita. Para facilitar a configuração dos vários diferentes \emph{gateways} no mercado a URL do Ajuda.Ai a ser configurada neles é padronizada, mudando apenas um parâmetro que representa qual \emph{gateway} fará requisições a URL. Na ilustração da figura \ref{fig:config_moip} temos a URL referente ao MoIP.

Uma vez criado um pagamento junto ao \emph{gateway} ele deve ser confirmado. Este estado é mais evidente quando o pagamento é feito por Boleto Bancário, pois o mesmo demora até 3 dias úteis para ser processado pelo banco e o retorno dado ao \emph{gateway}. Em pagamentos via cartão de crédito a confirmação é simplesmente o recebimento da requisição de crédito através dos sistemas da mesma, o que quase sempre é imediato.

Na confirmação o \emph{gateway} é informado do sucesso ou falha na execução do pagamento. Caso o pagamento não tenha sido feito, ele vai para o estado Recusado, caso contrário Finalizado. Como explicitado na figura \ref{fig:gateway} a praticamente qualquer momento do processo o usuário poderá Cancelar o pagamento. Apenas após 30 dias no estado Finalizado o pagamento que o cancelamento da operação fica indisponível, entretanto este prazo pode mudar de acordo com o \emph{gateway}. Vale salientar, também, que apenas após este prazo o dinheiro estará disponível para resgate pela instituição.

Cada mudança de estado resulta em uma chamada a URL configurada juntamente a um pacote de informações sobre o estado atual do pagamento. Cada \emph{Gateway} envia informações distintas, mas bastante semelhantes. A mais importante delas é o que é chamado de ID do Cliente que é um número especificado pelo Sistema e que será vinculado aquele pagamento. Este campo deve ser utilizado pelo Sistema para identificar internamente o que está sendo pago. O Ajuda.Ai utiliza este campo para manter o ID do objeto \codigo{Payment} gerado no início do processo a fim de manter o estado do pagamento e vincular a instituição correspondente.





\section{API REST Web Pública} \label{sec:ajudaai:api}

\textbf{\textit{--- Bla bla bla fazer alguma introdução? ---}}

A seguir está a API REST Web disponibilizada pelo Ajuda.Ai de forma pública, ou seja, com autenticação opcional por parte do usuário. Todos os parâmetros são obrigatórios, a menos que especificado que seja opcional. Parâmetros que fazem parte da própria URL são indicados com um sinal de dois-pontos no início de seu nome:

\begin{caixa}{Dados Públicos de um Usuário}{}

Retorna Identificador, Nome de Usuário, Primeiro nome e Último nome de um usuário cadastrado.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/profile/:username}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{username=String} - \textbf{(opcional se \codigo{id} for especificado)} Nome único de usuário
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item \codigo{id=Integer} - Identificador do usuário
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON de um objeto \codigo{User} apenas com os campos \codigo{id}, \codigo{username}, \codigo{firstname}, \codigo{lastname}
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Instituição não existe
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Dados de uma Instituição}{}

Retorna todos os dados de uma Instituição.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/:slug}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{slug=String} - Nome da URL da Instituição
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item Nenhum
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON com os dados da Instituição
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Instituição não existe
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Dados de uma Instituição escolhida Aleatoriamente}{}

Retorna todos os dados de uma Instituição escolhida aleatoriamente.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/random}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item Nenhum
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item Nenhum
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON com os dados da Instituição
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Não há nenhuma instituição cadastrada no banco de dados
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Estatísticas de Doações}{}

Retorna quantas doações a Instituição recebeu e o valor total das mesmas.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/:slug/donation-stats}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{slug=String} - Nome da URL da Instituição
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item Nenhum
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON no seguinte formato: \\ \codigo{\{ count: Integer, value: Real \}}
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Instituição não existe
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Doação - Passo 01: Registrar o Pagamento}{}

Inicia o processo de doação gravando os dados da mesma no Ajuda.Ai. Posteriormente o usuário deverá ser redirecionando para o \emph{gateway} de pagamento vinculado a Instituição através do método \codigo{/pagar/:id}.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/:slug/doar}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{POST}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{slug=String} - Nome da URL da Instituição
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
        \item \codigo{value=Integer} - Valor da Doação como um Inteiro (10000 = \$100,00)
        \item \codigo{name=String} - \textbf{(opcional se feito o login)} Nome Completo do Doador
        \item \codigo{email=String} - \textbf{(opcional se feito o login)} E-mail do Doador
        %\item \codigo{anonymous=Boolean} - Doação anônima?
        \item \codigo{addcosts=Boolean} - Adicionar custos operacionais do Gateway ao valor da doação?
        \item \codigo{addcoststype=Integer} - Tipo de pagamento que será utilizado (para cálculo do custo operacional)
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} Objeto \codigo{Payment} com os dados do pagamento criado
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Instituição não existe
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Doação - Passo 02: Redirecionamento ao \emph{Gateway}}{}

Continua o processo de doação redirecionando o usuário para o \emph{gateway} de pagamento vinculado ao \codigo{Payment} especificado.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/pagar/:id}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{id=UUID} - Identificador do pagamento (UUID)
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
        \item Nenhum
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{302 MOVED TEMPORARILY} \\ \textbf{Conteúdo:} Nenhum
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Pagamento não existe
        \item \textbf{Código:} \codigo{409 CONFLICT} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Notificações do \emph{Gateway} informam que este pagamento já está ou já foi processado.
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{\emph{Posts} de uma Instituição}{}

Retorna uma lista de tamanho limitado com os \emph{posts} de uma Instituição.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/:slug/posts}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item GET
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{slug=String} - Nome de URL da Instituição
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item \codigo{size=Integer} - \textbf{(opcional)} Quantidade de Itens na lista. Padrão: \codigo{10}. Máximo: \codigo{50}.
        \item \codigo{offset=Integer} - \textbf{(opcional)} Primeiro item da lista. Padrão: \codigo{0}.
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON no seguinte formato: \\ \codigo{\{ size: Integer, total: Integer, offset: Integer, items: [InstitutionPost] \}} \\
        Nota: os \emph{posts} não terão o campo \codigo{conteudo} preenchido.
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Instituição não existe
	\end{itemize}

\end{itemize}
\end{caixa}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Post Único de uma Instituição}{}

Retorna um único \emph{post} de uma Instituição.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/:slug/:post-slug}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
		\item \codigo{slug=String} - Nome da URL da Instituição
        \item \codigo{post-slug=String} - Nome da URL específico do \emph{post} da Instituição
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item Nenhum
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON com os dados do \emph{post} da Instituição
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Instituição ou \emph{Post} não existem
	\end{itemize}

\end{itemize}
\end{caixa}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{caixa}{Página do Website}{}

Retorna uma página do website com conteúdo livre. Páginas como estas são utilizadas para conteúdo que muda com pouca frequência como "Sobre", "Contato" e semelhantes.

\begin{itemize}
\item \textbf{URL}
	\begin{itemize}
		\item \codigo{/page/:page-slug}
	\end{itemize}

\item \textbf{Método}
	\begin{itemize}
		\item \codigo{GET}
	\end{itemize}

\item \textbf{Parâmetros}
	\begin{itemize}
        \item \codigo{page-slug=String} - Nome da URL da Página
	\end{itemize}

\item \textbf{Parâmetros de Dados}
	\begin{itemize}
		\item Nenhum
	\end{itemize}

\item \textbf{Resposta de Sucesso}
	\begin{itemize}
		\item \textbf{Código:} \codigo{200 OK} \\ \textbf{Conteúdo:} JSON do objeto \codigo{Page} da página requisitada. O campo \codigo{conteudo} será automaticamente convertido de Markdown para HTML.
	\end{itemize}

\item \textbf{Resposta de Erro}
	\begin{itemize}
		\item \textbf{Código:} \codigo{404 NOT FOUND} \\ \textbf{Conteúdo:} Nenhum \\ \textbf{Motivo:} Página inexistente
	\end{itemize}

\end{itemize}
\end{caixa}







\section*{Resumo} \label{sec:ajudaai:resumo}
Neste capítulo foi apresentada a solução Ajuda.Ai para \emph{crowdfunding} social, seu funcionamento, tecnologias utilizadas e arquitetura do sistema. Ao final, a API REST Web foi documentada.

Os próximos capítulos estão organizados da seguinte forma:

\begin{lista}
  \item \textbf{Conclusão:} Nesta seção é feita a conclusão do trabalho dado seus objetivos propostos;
  \item \textbf{Trabalhos Futuros:} Nesta seção são listados os trabalhos futuros para melhorar e/ou expandir a utilização da solução.
\end{lista}